
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feedback Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#f7f7f7; color:#0d0d0d; }}
    .container {{ max-width: 1200px; margin: 30px auto; padding: 0 16px; }}
    h1 {{ margin: 0 0 10px; }}
    .grid {{ display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }}
    .card {{ background:#fff; border:1px solid #e5e7eb; border-radius: 10px; padding: 16px; }}
    .span-4 {{ grid-column: span 4; }}
    .span-12 {{ grid-column: span 12; }}
    .muted {{ color:#6b7280; }}
    table {{ width: 100%; border-collapse: collapse; }}
    th, td {{ padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: left; vertical-align: top; }}
    th {{ background:#fafafa; }}
    .badge {{ display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; }}
    .good {{ background:#ecfdf5; color:#065f46; }}
    .meh  {{ background:#fef3c7; color:#92400e; }}
    .bad  {{ background:#fee2e2; color:#991b1b; }}
    .toolbar {{ display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap: wrap; }}
    .toolbar input, .toolbar select {{ padding:8px; border:1px solid #e5e7eb; border-radius:8px; }}
    .empty {{ text-align:center; color:#6b7280; padding: 24px; }}
    .error {{ background:#fff3f3; color:#b91c1c; border:1px solid #fecaca; padding:10px; margin-bottom:12px; display:none; }}
  </style>
</head>
<body>
  <div class="container">
    <h1>Feedback Dashboard</h1>
    <div class="muted">Live data from Supabase</div>

    <div id="err" class="error"></div>

    <div class="grid" style="margin-top:16px;">
      <div class="card span-4">
        <div class="muted">Average Overall</div>
        <div id="avgOverall" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
      <div class="card span-4">
        <div class="muted">% Positive (4–5)</div>
        <div id="pctPositive" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
      <div class="card span-4">
        <div class="muted">Responses</div>
        <div id="countResponses" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
    </div>

    <div class="card span-12" style="margin-top:16px;">
      <div class="toolbar">
        <input type="date" id="fromDate" />
        <input type="date" id="toDate" />
        <select id="filterRating">
          <option value="all">All ratings</option>
          <option value="positive">Only 4–5 (positive)</option>
          <option value="issues">1–3 only (issues)</option>
        </select>
        <button id="refreshBtn">Refresh</button>
      </div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>Name / Email</th>
              <th>Overall</th>
              <th>Food</th>
              <th>Drinks</th>
              <th>Service</th>
              <th>Ambience</th>
              <th>Recommend</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="empty" class="empty" style="display:none;">No feedback yet for this filter.</div>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient("https://mlzfdgmaohoatlhikhab.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1semZkZ21hb2hvYXRsaGlraGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODU0NjcsImV4cCI6MjA3MTE2MTQ2N30.YLsJ3bOf7AMYzWGHFsyjV-DE7xAPzWxI30zS02w2iRo");

    const errBox = document.getElementById('err');
    function showError(msg) {{ errBox.textContent = msg; errBox.style.display = 'block'; }}

    function badgeFor(stars) {{
      const s = Number(stars||0);
      if (s >= 4) return '<span class="badge good">'+s+'★</span>';
      if (s >= 2) return '<span class="badge meh">'+s+'★</span>';
      return '<span class="badge bad">'+s+'★</span>';
    }}

    function qs(sel) {{ return document.querySelector(sel); }}

    async function load() {{
      errBox.style.display = 'none';
      const from = qs('#fromDate').value;
      const to = qs('#toDate').value;
      const {{ data, error }} = await supabase
        .from('feedback')
        .select('*')
        .order('created_at', {{ ascending: false }});

      if (error) {{ showError(error.message); return; }}

      let rows = data || [];

      if (from) rows = rows.filter(r => new Date(r.created_at) >= new Date(from));
      if (to) rows = rows.filter(r => new Date(r.created_at) <= new Date(to + 'T23:59:59'));

      const mode = qs('#filterRating').value;
      if (mode === 'positive') rows = rows.filter(r => (r.overall||0) >= 4);
      if (mode === 'issues') rows = rows.filter(r => (r.overall||0) <= 3);

      const count = rows.length;
      const avg = count ? (rows.reduce((s,r)=>s+(Number(r.overall)||0),0)/count).toFixed(2) : '–';
      const pctPos = count ? Math.round(rows.filter(r => (r.overall||0) >= 4).length*100/count) + '%' : '–';
      qs('#countResponses').textContent = count;
      qs('#avgOverall').textContent = avg;
      qs('#pctPositive').textContent = pctPos;

      const tbody = qs('#tbl tbody');
      if (!count) {{
        tbody.innerHTML = '';
        qs('#empty').style.display = 'block';
        return;
      }} else {{
        qs('#empty').style.display = 'none';
      }}

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${{new Date(r.created_at).toLocaleString()}}</td>
          <td>${{(r.name||'—')}}<br><span class="muted">${{(r.email||'')}}</span></td>
          <td>${{badgeFor(r.overall)}}}</td>
          <td>${{r.food ?? ''}}</td>
          <td>${{r.drinks ?? ''}}</td>
          <td>${{r.service ?? ''}}</td>
          <td>${{r.ambience ?? ''}}</td>
          <td>${{r.recommend ?? ''}}</td>
          <td>${{(r.comments||'').replace(/</g,'&lt;')}}</td>
        </tr>
      `).join('');
    }}

    document.getElementById('refreshBtn').addEventListener('click', load);
    load();
  </script>
</body>
</html>
