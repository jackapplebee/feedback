
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feedback Dashboard</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#f7f7f7; color:#0d0d0d; }
    .container { max-width: 1100px; margin: 30px auto; padding: 0 16px; }
    h1 { margin: 0 0 10px; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius: 10px; padding: 16px; }
    .span-4 { grid-column: span 4; }
    .span-12 { grid-column: span 12; }
    .muted { color:#6b7280; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #f0f0f0; text-align: left; }
    th { background:#fafafa; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; }
    .good { background:#ecfdf5; color:#065f46; }
    .meh  { background:#fef3c7; color:#92400e; }
    .bad  { background:#fee2e2; color:#991b1b; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
    .toolbar input, .toolbar select { padding:8px; border:1px solid #e5e7eb; border-radius:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Feedback Dashboard</h1>
    <div class="muted">Live data from Supabase</div>

    <div class="grid" style="margin-top:16px;">
      <div class="card span-4">
        <div class="muted">Average Overall</div>
        <div id="avgOverall" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
      <div class="card span-4">
        <div class="muted">% Positive (4–5)</div>
        <div id="pctPositive" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
      <div class="card span-4">
        <div class="muted">Responses</div>
        <div id="countResponses" style="font-size: 28px; font-weight: 700;">–</div>
      </div>
    </div>

    <div class="card span-12" style="margin-top:16px;">
      <div class="toolbar">
        <input type="date" id="fromDate" />
        <input type="date" id="toDate" />
        <select id="minStars">
          <option value="0">All ratings</option>
          <option value="4">Only 4–5 (positive)</option>
          <option value="1">1–3 only (issues)</option>
        </select>
        <button id="refreshBtn">Refresh</button>
      </div>
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>Overall</th>
              <th>Food</th>
              <th>Drinks</th>
              <th>Service</th>
              <th>Ambience</th>
              <th>Recommend</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://mlzfdgmaohoatlhikhab.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1semZkZ21hb2hvYXRsaGlraGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODU0NjcsImV4cCI6MjA3MTE2MTQ2N30.YLsJ3bOf7AMYzWGHFsyjV-DE7xAPzWxI30zS02w2iRo";

    function badgeFor(stars) {
      if (stars >= 4) return '<span class="badge good">'+stars+'★</span>';
      if (stars >= 2) return '<span class="badge meh">'+stars+'★</span>';
      return '<span class="badge bad">'+stars+'★</span>';
    }

    function qs(sel) { return document.querySelector(sel); }

    async function load() {
      let url = SUPABASE_URL + '/rest/v1/feedback?select=*';
      const from = qs('#fromDate').value;
      const to = qs('#toDate').value;
      if (from) url += '&created_at=gte.' + new Date(from).toISOString();
      if (to) url += '&created_at=lte.' + new Date(to).toISOString();
      url += '&order=created_at.desc';

      const res = await fetch(url, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY } });
      const rows = await res.json();

      const min = parseInt(qs('#minStars').value, 10);
      let filtered = rows;
      if (min === 4) filtered = rows.filter(r => (r.overall||0) >= 4);
      if (min === 1) filtered = rows.filter(r => (r.overall||0) <= 3);

      const count = filtered.length;
      const avg = count ? (filtered.reduce((s,r)=>s+(r.overall||0),0)/count).toFixed(2) : '–';
      const posPct = count ? Math.round(filtered.filter(r=>(r.overall||0)>=4).length*100/count)+'%' : '–';
      qs('#avgOverall').textContent = avg;
      qs('#pctPositive').textContent = posPct;
      qs('#countResponses').textContent = count;

      const tbody = qs('#tbl tbody');
      tbody.innerHTML = filtered.map(r => `
        <tr>
          <td>${new Date(r.created_at).toLocaleString()}</td>
          <td>${badgeFor(r.overall||0)}</td>
          <td>${r.food||0}</td>
          <td>${r.drinks||0}</td>
          <td>${r.service||0}</td>
          <td>${r.ambience||0}</td>
          <td>${r.recommend||''}</td>
          <td>${(r.comments||'').replace(/</g,'&lt;')}</td>
        </tr>
      `).join('');
    }

    document.getElementById('refreshBtn').addEventListener('click', load);
    load();
  </script>
</body>
</html>
